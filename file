#!/bin/bash

# Database connection details
DB_HOST="pws1e-db-r12.w10e.com"
DB_PORT="1521"
DB_SID="CDBPWS1E"
DB_USER="system"
PDB_NAME="PWS1E"
LOG_FILE="hist_batches-headers-lines-newlog"

echo -n "Enter the database SYSTEM password for user $DB_USER: " > /dev/tty
read -s DB_PASS < /dev/tty
echo > /dev/tty

# PL/SQL block to execute
PLSQL_BLOCK=$(cat <<EOF
SET SERVEROUTPUT ON SIZE UNLIMITED
WHENEVER SQLERROR EXIT SQL.SQLCODE

DECLARE
    v_start_time TIMESTAMP;
    v_end_time TIMESTAMP;

    -- Procedure to safely execute a statement and log errors
    PROCEDURE safe_execute(p_sql IN VARCHAR2) IS
    BEGIN
        EXECUTE IMMEDIATE p_sql;
        DBMS_OUTPUT.PUT_LINE('SUCCESS: ' || p_sql);
    EXCEPTION
        WHEN OTHERS THEN
            DBMS_OUTPUT.PUT_LINE('ERROR: ' || p_sql || ' - ' || SQLERRM);
    END;

BEGIN
    -- Log the start time
    SELECT SYSTIMESTAMP INTO v_start_time FROM DUAL;
    DBMS_OUTPUT.PUT_LINE('Script Start Time: ' || v_start_time);

    -- XXGLARC.GL_HIST_BATCHES_CSI_2022_NEW indexes
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_BATCHES_CSI_2022_LST_UPD_NEW ON XXGLARC.GL_HIST_BATCHES_CSI_2022_NEW (LAST_UPDATE_DATE) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_BATCHES_CSI_2022_GRP_ID_NEW ON XXGLARC.GL_HIST_BATCHES_CSI_2022_NEW (GROUP_ID) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_BATCHES_CSI_2022_STS_NEW ON XXGLARC.GL_HIST_BATCHES_CSI_2022_NEW (STATUS) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_BATCHES_CSI_2022_POST_JE_BTCH_NEW ON XXGLARC.GL_HIST_BATCHES_CSI_2022_NEW (POSTED_DATE, JE_BATCH_ID) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE UNIQUE INDEX XXGLARC.XX_GL_HIST_BATCHES_CSI_2022_JE_BTCH_NEW ON XXGLARC.GL_HIST_BATCHES_CSI_2022_NEW (JE_BATCH_ID) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE UNIQUE INDEX XXGLARC.XX_GL_HIST_BATCHES_CSI_2022_NM_PRD_COA_NEW ON XXGLARC.GL_HIST_BATCHES_CSI_2022_NEW (NAME, DEFAULT_PERIOD_NAME, CHART_OF_ACCOUNTS_ID, PERIOD_SET_NAME, ACCOUNTED_PERIOD
_TYPE) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_BATCHES_CSI_2022_STS_POST_NEW ON XXGLARC.GL_HIST_BATCHES_CSI_2022_NEW (STATUS, POSTING_RUN_ID) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_BATCHES_CSI_2022_FLG_PRD_NEW ON XXGLARC.GL_HIST_BATCHES_CSI_2022_NEW (ACTUAL_FLAG, DEFAULT_PERIOD_NAME) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');

    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_BATCHES_CSI_2022_LST_UPD_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_BATCHES_CSI_2022_GRP_ID_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_BATCHES_CSI_2022_STS_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_BATCHES_CSI_2022_POST_JE_BTCH_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_BATCHES_CSI_2022_JE_BTCH_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_BATCHES_CSI_2022_NM_PRD_COA_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_BATCHES_CSI_2022_STS_POST_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_BATCHES_CSI_2022_FLG_PRD_NEW NOPARALLEL');

    -- XXGLARC.GL_HIST_HEADERS_CSI_2022_NEW indexes
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_JE_HD_CRC_NEW ON XXGLARC.GL_HIST_HEADERS_CSI_2022_NEW (JE_HEADER_ID, CURRENCY_CODE) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_POST_JE_HEAD_NEW ON XXGLARC.GL_HIST_HEADERS_CSI_2022_NEW (POSTED_DATE, JE_HEADER_ID) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_JE_BTCH_NEW ON XXGLARC.GL_HIST_HEADERS_CSI_2022_NEW (JE_BATCH_ID) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_PRD_NM_JECAT_NEW ON XXGLARC.GL_HIST_HEADERS_CSI_2022_NEW (PERIOD_NAME, JE_CATEGORY) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_DOC_VAL_ID_NEW ON XXGLARC.GL_HIST_HEADERS_CSI_2022_NEW (DOC_SEQUENCE_VALUE, DOC_SEQUENCE_ID) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_PRNT_JE_ID_NEW ON XXGLARC.GL_HIST_HEADERS_CSI_2022_NEW (PARENT_JE_HEADER_ID) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE UNIQUE INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_JE_HD_NEW ON XXGLARC.GL_HIST_HEADERS_CSI_2022_NEW (JE_HEADER_ID) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE UNIQUE INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_NM_JE_BTCH_NEW ON XXGLARC.GL_HIST_HEADERS_CSI_2022_NEW (NAME, JE_BATCH_ID) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_AT1_JE_HEAD_REV_NEW ON XXGLARC.GL_HIST_HEADERS_CSI_2022_NEW (ATTRIBUTE1, JE_HEADER_ID, ACCRUAL_REV_JE_HEADER_ID) TABLESPACE APPS_TS_TX_IDX PARALL
EL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_EXT_RF_NEW ON XXGLARC.GL_HIST_HEADERS_CSI_2022_NEW (EXTERNAL_REFERENCE) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_PST_JE_CRC_NEW ON XXGLARC.GL_HIST_HEADERS_CSI_2022_NEW (POSTED_DATE, JE_HEADER_ID, CURRENCY_CODE) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_LST_NEW ON XXGLARC.GL_HIST_HEADERS_CSI_2022_NEW (LAST_UPDATE_DATE) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_LGR_JE_NM_NEW ON XXGLARC.GL_HIST_HEADERS_CSI_2022_NEW (LEDGER_ID, JE_BATCH_ID, NAME) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');

    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_JE_HD_CRC_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_POST_JE_HEAD_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_JE_BTCH_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_PRD_NM_JECAT_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_DOC_VAL_ID_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_PRNT_JE_ID_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_JE_HD_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_NM_JE_BTCH_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_AT1_JE_HEAD_REV_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_EXT_RF_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_PST_JE_CRC_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_LST_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_HEADERS_CSI_2022_LGR_JE_NM_NEW NOPARALLEL');

    -- XXGLARC.GL_HIST_LINES_CSI_2022_NEW indexes
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_AT17_CC_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (ATTRIBUTE17, CODE_COMBINATION_ID) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_AT15_STS_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (ATTRIBUTE15, STATUS) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_AT16_STS_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (ATTRIBUTE16, STATUS) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_CC_CR_DAT_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (CODE_COMBINATION_ID, CREATION_DATE) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_EF_DAT_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (EFFECTIVE_DATE) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_CC_PRD_NM_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (CODE_COMBINATION_ID, PERIOD_NAME) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_SUB_VAL_ID_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (SUBLEDGER_DOC_SEQUENCE_VALUE, SUBLEDGER_DOC_SEQUENCE_ID) TABLESPACE APPS_TS_TX_IDX PARALLEL 2
0');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_RF1_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (REFERENCE_1) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_RF3_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (REFERENCE_3) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_LGR_AT15_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (LEDGER_ID, ATTRIBUTE15) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_LGR_STS_EF_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (LEDGER_ID, STATUS, EFFECTIVE_DATE) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_LGR_STS_JE_CC_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (LEDGER_ID, STATUS, JE_HEADER_ID, CODE_COMBINATION_ID) TABLESPACE APPS_TS_TX_IDX PARALLEL 2
0');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_LGR_JE_NM_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (LEDGER_ID, JE_LINE_NUM) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_CC_LGR_AT15_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (CODE_COMBINATION_ID, LEDGER_ID, ATTRIBUTE15) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_CC_STS_LGR_EF_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (CODE_COMBINATION_ID, STATUS, LEDGER_ID, EFFECTIVE_DATE) TABLESPACE APPS_TS_TX_IDX PARALLEL
 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_JE_CC_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (JE_HEADER_ID, CODE_COMBINATION_ID) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_CR_DAT_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (CREATION_DATE) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');
    safe_execute('CREATE UNIQUE INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_JE_ID_NM_NEW ON XXGLARC.GL_HIST_LINES_CSI_2022_NEW (JE_HEADER_ID, JE_LINE_NUM) TABLESPACE APPS_TS_TX_IDX PARALLEL 20');

    safe_execute('ALTER TABLE XXGLARC.GL_HIST_LINES_CSI_2022_NEW ADD CONSTRAINT GL_HIST_LINES_CSI_2022_PK PRIMARY KEY (JE_HEADER_ID, JE_LINE_NUM) USING INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_JE_ID_NM_NEW ENABLE'
);

    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_AT17_CC_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_AT15_STS_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_AT16_STS_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_CC_CR_DAT_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_EF_DAT_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_CC_PRD_NM_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_SUB_VAL_ID_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_RF1_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_RF3_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_LGR_AT15_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_LGR_STS_EF_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_LGR_STS_JE_CC_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_LGR_JE_NM_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_CC_LGR_AT15_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_CC_STS_LGR_EF_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_JE_CC_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_CR_DAT_NEW NOPARALLEL');
    safe_execute('ALTER INDEX XXGLARC.XX_GL_HIST_LINES_CSI_2022_JE_ID_NM_NEW NOPARALLEL');

    -- Log the end time
    SELECT SYSTIMESTAMP INTO v_end_time FROM DUAL;
    DBMS_OUTPUT.PUT_LINE('Script End Time: ' || v_end_time);
    DBMS_OUTPUT.PUT_LINE('Duration: ' || (v_end_time - v_start_time));

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Unhandled Error: ' || SQLERRM);
        RAISE;
END;
/
EOF
)

# Connect to the database and execute the PL/SQL block
sqlplus -S "$DB_USER/$DB_PASS@$DB_HOST:$DB_PORT/$DB_SID" <<EOF > $LOG_FILE 2>&1
ALTER SESSION SET CONTAINER=$PDB_NAME;
$PLSQL_BLOCK
EOF

echo "Script executed. Check $LOG_FILE for details."
